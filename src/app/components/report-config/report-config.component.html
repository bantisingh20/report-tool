<p-tabView [(activeIndex)]="activeTab" class="p-tabview-sm">

  <!-- Tab 1: Report Configuration -->
  <p-tabPanel header="Report Configuration">
    <form [formGroup]="reportForm" class="space-y-6 p-6 shadow rounded-lg">

      <!-- Field Type -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Field Type</label>
        <div class="flex space-x-6">
          <label class="inline-flex items-center space-x-2">
            <input type="radio" formControlName="fieldtype" value="count" />
            <span>Count</span>
          </label>
          <label class="inline-flex items-center space-x-2">
            <input type="radio" formControlName="fieldtype" value="summary" />
            <span>Summary</span>
          </label>
        </div>

        <div *ngIf="reportForm.get('fieldtype')?.invalid && reportForm.get('fieldtype')?.touched"
          class="text-red-500 text-sm mt-1">
          Field Type is required.
        </div>
      </div>

      <!-- Tables -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Tables</label>
        <p-multiSelect [options]="tablesAndViews" optionLabel="label" optionValue="name" formControlName="tableandview"
          placeholder="Select Tables" (onChange)="onTableSelect($event)" [showToggleAll]="false" display="chip"
          (onHide)="dropdownCloseFunction()" class="w-full">
        </p-multiSelect>

        <div *ngIf="reportForm.get('tableandview')?.invalid && reportForm.get('tableandview')?.touched"
          class="text-red-500 text-sm mt-1">
          Please select at least one table.
        </div>

      </div>

      <!-- bindLabel="label" bindValue="name"  -->
      <!-- XY Config or Columns -->
      <div *ngIf="reportForm.get('fieldtype')?.value === 'count'">
        <label class="block text-sm font-semibold text-gray-700 mb-2">XY Configuration</label>
        <div class="p-4 border border-gray-300 bg-gray-100 rounded">XY Config UI here</div>
      </div>

      <div *ngIf="reportForm.get('fieldtype')?.value === 'summary'">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Columns</label>
        <p-multiSelect [options]="availableFields" optionLabel="label" optionValue="column_name"
          formControlName="selectedcolumns" placeholder="Select columns" (onChange)="onColumnSelect($event)"
          [showToggleAll]="false" display="chip" class="w-full">
        </p-multiSelect>

        <div *ngIf="reportForm.get('selectedcolumns')?.invalid && reportForm.get('selectedcolumns')?.touched"
          class="text-red-500 text-sm mt-1">
          Please select at least one column.
        </div>

      </div>

    </form>
  </p-tabPanel>

  <!-- Tab 2: Filters / Sort / Group By -->
  <p-tabPanel header="Filters / Sort / Group By" *ngIf="isColumnSelected">
    <div class="space-y-8 p-6 shadow-md rounded-lg" [formGroup]="reportForm">

      <!-- Filters Section -->
      <div formArrayName="filters" class="space-y-4">
        <h5 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <i class="bi bi-funnel text-red-500"></i> Filters
        </h5>

        <div *ngFor="let filter of filters.controls; let i = index" [formGroupName]="i"
          class="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">

          <!-- Field -->
          <div>
            <p-dropdown [options]="selectedcolumns" bindLabel="label" bindValue="column_name" formControlName="field"
              placeholder="Select filter" [showClear]="true" class="w-full" (onChange)="onFieldChange($event, i)">
            </p-dropdown>
            <div *ngIf="filter.get('field')?.invalid && filter.get('field')?.touched" class="text-red-500 text-sm mt-1">
              Field is required.
            </div>
          </div>

          <!-- Operator -->
          <div>
            <p-dropdown [options]="operators" formControlName="operator" placeholder="Select Operator"
              [showClear]="true" class="w-full" (onChange)="onOperatorChange(i)">
            </p-dropdown>
            <div *ngIf="filter.get('operator')?.invalid && filter.get('operator')?.touched"
              class="text-red-500 text-sm mt-1">
              Operator is required.
            </div>
          </div>

          <!-- Value Inputs for "between" operator -->
          <ng-container *ngIf="filter.get('operator')?.value === 'between'; else singleValue">
            <div class="grid grid-cols-1 gap-2">
              <p-inputText formControlName="valueFrom" placeholder="From" class="w-full" />
              <div *ngIf="filter.get('valueFrom')?.invalid && filter.get('valueFrom')?.touched"
                class="text-red-500 text-sm">
                From value is required.
              </div>
              <p-inputText formControlName="valueTo" placeholder="To" class="w-full" />
              <div *ngIf="filter.get('valueTo')?.invalid && filter.get('valueTo')?.touched"
                class="text-red-500 text-sm">
                To value is required.
              </div>
            </div>
          </ng-container>

          <!-- Other operators: show single input -->
          <ng-template #singleValue>
            <div>
              <p-inputText formControlName="value" placeholder="Enter value" class="w-full" />
              <div *ngIf="filter.get('value')?.invalid && filter.get('value')?.touched"
                class="text-red-500 text-sm mt-1">
                Value is required.
              </div>
            </div>
          </ng-template>

          <!-- Remove Filter Button -->
          <div class="flex justify-end">
            <button type="button" pButton icon="pi pi-trash" class="p-button-danger p-button-rounded p-button-sm"
              (click)="removeFilter(i)" title="Remove filter"></button>
          </div>
        </div>

        <!-- Add Filter Button -->
        <button type="button" pButton icon="pi pi-plus-circle" label="Add Filter" class="p-button-text p-button-primary"
          (click)="addFilter()" title="Add a new filter"></button>
      </div>

      <!-- Grouping Section -->
      <div formArrayName="groupby" *ngIf="showColumnsAndGroupBy" class="space-y-4">
        <h5 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <i class="bi bi-collection text-blue-500"></i> Grouping
        </h5>
        <p class="text-sm text-gray-500">Step 3: Group your data (e.g., by department or location).</p>

        <div *ngFor="let group of groupby.controls; let i = index" [formGroupName]="i" class="flex items-center gap-2">
          <p-dropdown [options]="selectedcolumns" bindLabel="label" bindValue="column_name" formControlName="field"
            placeholder="Select Field" [showClear]="true" class="w-full">
          </p-dropdown>
          <div *ngIf="group.get('field')?.invalid && group.get('field')?.touched" class="text-red-500 text-sm">
            Field is required.
          </div>
          <button type="button" pButton icon="pi pi-trash" class="p-button-danger p-button-rounded p-button-sm"
            (click)="removeGrouping(i)" title="Remove grouping"></button>
        </div>

        <button *ngIf="groupby.length === 0" type="button" pButton icon="pi pi-plus-circle" label="Add Grouping"
          class="p-button-text p-button-primary" (click)="addGrouping()" title="Add grouping"></button>
      </div>


      <!-- Sorting Section -->
      <div formArrayName="sortby" class="space-y-4">
        <h5 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <i class="bi bi-sort-alpha-down text-gray-500"></i> Sorting
        </h5>
        <p class="text-sm text-gray-500">Step 4: Choose how to order the data.</p>

        <div *ngFor="let sort of sortby.controls; let i = index" [formGroupName]="i"
          class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">

          <!-- Field Dropdown -->
          <div>
            <p-dropdown [options]="selectedcolumns" bindLabel="label" bindValue="column_name" formControlName="field"
              placeholder="Select Field" [showClear]="true" class="w-full">
            </p-dropdown>

            <div *ngIf="sort.get('field')?.invalid && sort.get('field')?.touched" class="text-red-500 text-sm mt-1">
              Field is required.
            </div>
          </div>

          <!-- Direction Dropdown -->
          <div>
            <p-dropdown [options]="[
          { label: 'Ascending (A-Z)', value: 'asc' },
          { label: 'Descending (Z-A)', value: 'desc' }
        ]" formControlName="direction" placeholder="Sort Direction" [showClear]="true" class="w-full">
            </p-dropdown>
          </div>

          <!-- Remove Button -->
          <div class="flex justify-end">
            <button type="button" pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-sm"
              (click)="removeSorting(i)" title="Remove sorting">
            </button>
          </div>

        </div>

        <!-- Add Sorting Button -->
        <button type="button" *ngIf="sortby.length <= 1" pButton icon="pi pi-plus-circle" label="Add Sorting"
          class="p-button-text p-button-primary" (click)="addSorting()" title="Add sorting">
        </button>
      </div>


    </div>
  </p-tabPanel>

  <app-common-table></app-common-table>

  <p-dialog header="Save Report" [(visible)]="showSaveModal" [modal]="true" [closable]="false"
    [style]="{ width: '30vw' }">
    <div class="p-fluid space-y-4" [formGroup]="reportForm">
      <div>
        <label for="reportname" class="block text-sm font-semibold mb-2">Report Name</label>
        <input id="reportname" type="text" pInputText formControlName="reportname" placeholder="Enter report name"
          class="w-full" />
        <div *ngIf="reportForm.get('reportname')?.invalid && reportForm.get('reportname')?.touched"
          class="text-red-500 text-sm">
          Report name is required.
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button pButton label="Cancel" class="p-button-text" (click)="showSaveModal = false"></button>
        <button pButton label="Save" class="p-button-primary" (click)="onConfirmSave()"
          [disabled]="reportForm.invalid"></button>
      </div>
    </div>
  </p-dialog>


  <!-- Action Buttons -->
  <div class="flex flex-wrap justify-end gap-3 mt-6">

    <button pButton type="button" label="Back" class="p-button-secondary" (click)="onBack()"></button>

    <button pButton type="button" label="Reset" class="p-button-warning" (click)="addNewReport()"></button>

    <button pButton type="button" label="Search" class="p-button-primary" (click)="previewReport()"></button>

    <button pButton type="button" label="Save" class="p-button-success" (click)="showSaveModal = true"></button>

  </div>


</p-tabView>