<p-tabView [(activeIndex)]="activeTab" class="p-tabview-sm">

  <!-- Tab 1: Report Configuration -->
  <p-tabPanel header="Report Configuration">
    <form [formGroup]="reportForm" class="space-y-6 p-6 shadow rounded-lg">

      <!-- Field Type -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Field Type</label>
        <div class="flex space-x-6">
          <label class="inline-flex items-center space-x-2">
            <input type="radio" formControlName="fieldtype" value="count" (change)="onFieldTypeChange()" />
            <span>Count</span>
          </label>
          <label class="inline-flex items-center space-x-2">
            <input type="radio" formControlName="fieldtype" value="summary" (change)="onFieldTypeChange()" />
            <span>Summary</span>
          </label>
        </div>

        <div *ngIf="reportForm.get('fieldtype')?.invalid && reportForm.get('fieldtype')?.touched"
          class="text-red-500 text-sm mt-1">
          Field Type is required.
        </div>
      </div>

      <!-- Tables -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Tables</label>
        <p-multiSelect [options]="tablesAndViews" optionLabel="label" optionValue="name" formControlName="tableandview"
          placeholder="Select Tables" (onChange)="onTableSelect($event)" [showToggleAll]="false" display="chip"
          (onHide)="dropdownCloseFunction()" class="w-full">
        </p-multiSelect>

        <div *ngIf="reportForm.get('tableandview')?.invalid && reportForm.get('tableandview')?.touched"
          class="text-red-500 text-sm mt-1">
          Please select at least one table.
        </div>

      </div>


       <div *ngIf="reportForm.get('fieldtype')?.value === 'summary'">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Columns</label>
        <p-multiSelect [options]="availableFields" optionLabel="label" optionValue="column_name"
          formControlName="selectedcolumns" placeholder="Select columns" (onChange)="onColumnSelect($event)"
          [showToggleAll]="false" display="chip" class="w-full">
        </p-multiSelect>

        <div *ngIf="reportForm.get('selectedcolumns')?.invalid && reportForm.get('selectedcolumns')?.touched"
          class="text-red-500 text-sm mt-1">
          Please select at least one column.
        </div>

      </div>

      <!-- XY Config or Columns -->
      <div *ngIf="reportForm.get('fieldtype')?.value === 'count'">
        <label class="block text-sm font-semibold text-gray-700 mb-2">XY Configuration</label>

        <div formArrayName="xyaxis" class="mb-4 space-y-4">

          <div *ngFor="let axis of xyaxis.controls; let i = index" [formGroupName]="i" class="flex flex-wrap gap-4">

            <!-- X-Axis Field Selection -->
            <div class="flex-1 min-w-[200px]">
              <p-dropdown [options]="selectedcolumns" formControlName="xAxisField" optionLabel="label"
                optionValue="column_name" placeholder="Select columns" (onChange)="onXAxisFieldChange(i)"
                class="w-full">
              </p-dropdown>

              <div *ngIf="xyaxis.get('xAxisField')?.invalid && xyaxis.get('xAxisField')?.touched"
                class="text-red-600 text-sm mt-1">
                Field is required.
              </div>
            </div>

            <!-- X-Axis Data Transformation Options -->
            <div class="flex-1 min-w-[200px]" *ngIf="showXAxisTransformationOptions(i)">
              <p-dropdown formControlName="xAxisTransformation" [options]="xAxisTransformationOptions">
                <ng-template pTemplate="selectedItem" let-selected>
                  {{ selected?.label }}
                </ng-template>
              </p-dropdown>
            </div>

            <!-- X-Axis Direction (Hidden) -->
            <div class="hidden">
              <p-dropdown formControlName="xAxisDirection" [options]="xAxisDirectionOptions">
                <ng-template pTemplate="selectedItem" let-selected>
                  {{ selected?.label }}
                </ng-template>
              </p-dropdown>
            </div>

            <!-- Y-Axis Field Selection -->
            <div class="flex-1 min-w-[200px]">
              <p-dropdown [options]="availableFields" formControlName="yAxisField" optionLabel="label"
                optionValue="column_name" placeholder="Select Y-Axis Field" class="w-full">
              </p-dropdown>

              <div *ngIf="xyaxis.get('yAxisField')?.invalid && xyaxis.get('yAxisField')?.touched"
                class="text-red-600 text-sm mt-1">
                Field is required.
              </div>
            </div>

            <!-- Y-Axis Aggregation Options -->
            <div class="flex-1 min-w-[200px]" *ngIf="showYAxisAggregationOptions(i)">

              <p-dropdown [options]="getYaxisAggregationOptions(i)" formControlName="yAxisAggregation"
                optionLabel="label" optionValue="value" placeholder="Select Y-Axis Aggregation" class="w-full">
              </p-dropdown>

            </div>

            <!-- Y-Axis Direction (Hidden) -->
            <div class="hidden">
              <p-dropdown formControlName="yAxisDirection">
                <ng-template pTemplate="selectedItem" let-selected>
                  {{ selected?.label }}
                </ng-template>
              </p-dropdown>
            </div>

            <!-- Remove Button -->
            <div class="flex items-center">
              <p-button icon="pi pi-trash" class="p-button-rounded p-button-outlined p-button-danger"
                (click)="removeXYAxis(i)" title="Remove X-Y Axis">
              </p-button>
            </div>
          </div>

          <!-- Add New XY Axis Button -->

          <p-button *ngIf="xyaxis.length === 0" icon="pi pi-plus-circle"
            class="p-button-sm p-button-outline p-button-primary mt-2" (click)="addXYAxis()" title="Add X-Y Axis">
          </p-button>
        </div>
      </div>
 

    </form>
  </p-tabPanel>

  <!-- Tab 2: Filters / Sort / Group By -->
  <p-tabPanel header="Filters / Sort / Group By"
    *ngIf="isColumnSelected || this.reportForm.get('fieldtype')?.value =='count'">
    <div class="space-y-8 p-6 shadow-md rounded-lg" [formGroup]="reportForm">

      <!-- Filters Section -->
      <div formArrayName="filters" class="space-y-4">
        <h5 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <i class="bi bi-funnel text-red-500"></i> Filters
        </h5>

        <div *ngFor="let filter of filters.controls; let i = index" [formGroupName]="i"
          class="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">

          <div>
            <p-dropdown [options]="selectedcolumns" bindLabel="label" bindValue="column_name" formControlName="field"
              placeholder="Select filter" [showClear]="true" class="w-full" (onChange)="onFilterFieldChange($event, i)">
            </p-dropdown>
            <div *ngIf="filter.get('field')?.invalid && filter.get('field')?.touched" class="text-red-500 text-sm mt-1">
              Field is required.
            </div>
          </div>

          <div>
            <!-- <p-dropdown [options]="operators" formControlName="operator" placeholder="Select Operator"
              [showClear]="true" class="w-full" (onChange)="onOperatorChange(i)">
            </p-dropdown> -->

            <p-dropdown [options]="operatorsByRow[i] || []" formControlName="operator" placeholder="Select Operator"
              [showClear]="true" class="w-full" (onChange)="onOperatorChange(i)">
            </p-dropdown>
            <div *ngIf="filter.get('operator')?.invalid && filter.get('operator')?.touched"
              class="text-red-500 text-sm mt-1">
              Operator is required.
            </div>
          </div>

          <ng-container *ngIf="filter.get('operator')?.value === 'between'; else singleValue">
            <div class="grid grid-cols-1 gap-2">
              <input [type]="getInputType(filter.get('selectedField')?.value?.value?.data_type)"
                formControlName="valueFrom" placeholder="From" class="w-full p-inputtext p-component" />
              <div *ngIf="filter.get('valueFrom')?.invalid && filter.get('valueFrom')?.touched"
                class="text-red-500 text-sm">
                From value is required.
              </div>

              <input [type]="getInputType(filter.get('selectedField')?.value?.value?.data_type)"
                formControlName="valueTo" placeholder="To" class="w-full p-inputtext p-component" />
              <div *ngIf="filter.get('valueTo')?.invalid && filter.get('valueTo')?.touched"
                class="text-red-500 text-sm">
                To value is required.
              </div>
            </div>
          </ng-container>

          <ng-template #singleValue>
            <div>
              <input [type]="getInputType(filter.get('selectedField')?.value?.value?.data_type)" formControlName="value"
                placeholder="Enter value" class="w-full p-inputtext p-component" />
              <div *ngIf="filter.get('value')?.invalid && filter.get('value')?.touched"
                class="text-red-500 text-sm mt-1">
                Value is required.
              </div>
            </div>
          </ng-template>



          <div class="flex justify-end">
            <p-button icon="pi pi-trash" class="p-button-rounded p-button-outlined p-button-danger"
              (click)="removeFilter(i)" title="Remove Filter">
            </p-button>
          </div>
        </div>

        <p-button *ngIf="xyaxis.length === 0" icon="pi pi-plus-circle"
          class="p-button-sm p-button-outline p-button-primary mt-2" (click)="addFilter()" title="Add Filter">
        </p-button>

      </div>

      <!-- Grouping Section -->
      <div formArrayName="groupby" *ngIf="showColumnsAndGroupBy" class="space-y-4">
        <h5 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <i class="bi bi-collection text-blue-500"></i> Grouping
        </h5>
          
        <div *ngFor="let group of groupby.controls; let i = index" [formGroupName]="i" class="flex items-center gap-2">
          <p-dropdown [options]="selectedcolumns" bindLabel="label" bindValue="column_name" formControlName="field"
            placeholder="Select Field" [showClear]="true" class="w-full">
          </p-dropdown>
          <div *ngIf="group.get('field')?.invalid && group.get('field')?.touched" class="text-red-500 text-sm">
            Field is required.
          </div>

          <p-button icon="pi pi-trash" class="p-button-rounded p-button-outlined p-button-danger"
            (click)="removeGrouping(i)" title="Remove Grouping">
          </p-button>

        </div>

        <p-button *ngIf="groupby.length === 0" icon="pi pi-plus-circle"
          class="p-button-sm p-button-outline p-button-primary mt-2" (click)="addGrouping()" title="Add Grouping">
        </p-button>
      </div>


      <!-- Sorting Section -->
      <div formArrayName="sortby" class="space-y-4">
        <h5 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <i class="bi bi-sort-alpha-down text-gray-500"></i> Sorting
        </h5>

        <div *ngFor="let sort of sortby.controls; let i = index" [formGroupName]="i"
          class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">

          <!-- Field Dropdown -->
          <div>
            <p-dropdown [options]="selectedcolumns" bindLabel="label" bindValue="column_name" formControlName="field"
              placeholder="Select Field" [showClear]="true" class="w-full">
            </p-dropdown>


            <div *ngIf="sort.get('field')?.invalid && sort.get('field')?.touched" class="text-red-500 text-sm mt-1">
              Field is required.
            </div>
          </div>

          <!-- Direction Dropdown -->
          <div>
            <p-dropdown [options]="[
          { label: 'Ascending (A-Z)', value: 'asc' },
          { label: 'Descending (Z-A)', value: 'desc' }
        ]" formControlName="direction" placeholder="Sort Direction" [showClear]="true" class="w-full">
            </p-dropdown>
          </div>

          <!-- Remove Button -->
          <div class="flex justify-end">
            <p-button icon="pi pi-trash" class="p-button-rounded p-button-outlined p-button-danger"
              (click)="removeSorting(i)" title="Remove sorting">
            </p-button>
          </div>

        </div>

        <!-- Add Sorting Button -->

        <p-button *ngIf="sortby.length <=1 " icon="pi pi-plus-circle"
          class="p-button-sm p-button-outline p-button-primary mt-2" (click)="addSorting()" title="Add Sorting">
        </p-button>

      </div>


    </div>
  </p-tabPanel>

  <p-dialog header="Save Report" [(visible)]="showSaveModal" [modal]="true" [closable]="false"
    [style]="{ width: '30vw' }">
    <div class="p-fluid space-y-4" [formGroup]="reportForm">
      <div>
        <label for="reportname" class="block text-sm font-semibold mb-2">Report Name</label>
        <input id="reportname" type="text" pInputText formControlName="reportname" placeholder="Enter report name"
          class="w-full" />
        <div *ngIf="reportForm.get('reportname')?.invalid && reportForm.get('reportname')?.touched"
          class="text-red-500 text-sm">
          Report name is required.
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button pButton label="Cancel" class="p-button-text" (click)="showSaveModal = false"></button>
        <button pButton label="Save" class="p-button-primary" (click)="onConfirmSave()"
          [disabled]="reportForm.invalid"></button>
      </div>
    </div>
  </p-dialog>

  <app-chart-component [chartDataArray]="previewData.chartData"
    *ngIf="showPreview && previewData.ischart"></app-chart-component>
  <app-common-table *ngIf="showPreview && !previewData.ischart" [InputData]="previewData.data"
    [israw]="!previewData.isGroup" [Inputgroupby]="previewData.groupBy" [group]="previewData.isGroup">
  </app-common-table>

  <!-- Action Buttons -->
  <div class="flex flex-wrap justify-end gap-3 mt-6">

    <button pButton type="button" label="Back" class="p-button-secondary" (click)="onBack()"></button>

    <button pButton type="button" label="Reset" class="p-button-warning" (click)="addNewReport()"></button>

    <button pButton type="button" label="Search" class="p-button-primary" (click)="previewReport()"></button>

    <button pButton type="button" label="Save" class="p-button-success" (click)="showSaveModal = true"></button>

  </div>


</p-tabView>